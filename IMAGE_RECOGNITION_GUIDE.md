# 图像识别功能使用指南

本系统已集成图像识别功能，可以自动识别医疗文书图片并提取关键信息。

## 功能特点

1. **智能识别多种医疗文书类型**
   - 病历
   - 生化检查报告
   - 血常规报告
   - 营养评估表
   - 人体测量记录
   - 护理记录
   - 会诊记录

2. **自动提取关键数据**
   - 诊断信息
   - 实验室检查结果
   - 营养评分（如NRS2002）
   - 人体测量数据（身高、体重、BMI）

3. **数据质量控制**
   - 识别结果实时展示
   - 支持手动编辑和修正
   - 数据追溯功能

## 使用流程

### 1. 网页端使用

1. 访问营养评估系统首页
2. 点击"图像识别"模式
3. 上传医疗文书图片（支持多张）
4. 点击"开始识别"按钮
5. 系统自动识别并提取数据
6. 检查识别结果，必要时手动编辑
7. 点击"开始评估"进行营养评估

### 2. API调用方式

#### 仅图像识别
```bash
POST /api/recognize-images
Content-Type: multipart/form-data

# 表单数据
image_0: [图片文件1]
image_1: [图片文件2]
...
```

#### 图像识别+营养评估
```bash
POST /api/assessment-with-images
Content-Type: multipart/form-data

# 表单数据
patientData: {"patient_info": {...}, ...}  # JSON字符串
image_0: [图片文件1]
image_1: [图片文件2]
...
```

## 系统架构

### 新增组件

1. **ImageRecognizer智能体** (`backend/agents/image_recognizer.py`)
   - 使用Gemini-2.5-flash模型
   - 处理图像识别任务
   - 提取结构化医疗数据

2. **图像识别API路由** (`src/app/api/recognize-images/route.ts`)
   - 接收图像上传
   - 调用Python服务处理
   - 返回识别结果

3. **增强的评估API** (`src/app/api/assessment-with-images/route.ts`)
   - 同时处理患者数据和图像
   - 整合识别结果到评估流程

4. **更新的前端界面**
   - 双模式切换（JSON输入/图像识别）
   - 图像上传功能
   - 识别结果展示
   - 数据编辑功能

## 技术实现细节

### 图像识别流程
1. 前端上传图像文件
2. API路由保存到临时目录
3. Python服务调用ImageRecognizer
4. Gemini API分析图像内容
5. 提取并返回结构化数据
6. 清理临时文件

### 数据整合机制
- 图像识别结果自动映射到标准患者数据格式
- 支持增量更新（不覆盖现有数据）
- 保留数据追溯信息

## 测试方法

### 后端测试
```bash
cd backend
python test_image_recognition.py
```

### 前端测试
1. 启动开发服务器：`npm run dev`
2. 访问 http://localhost:3000
3. 切换到"图像识别"模式
4. 上传测试图片进行测试

## 注意事项

1. **图像要求**
   - 支持常见图片格式（JPG、PNG等）
   - 图片应清晰可读
   - 建议分辨率不低于720p

2. **隐私保护**
   - 上传的图像仅用于识别处理
   - 处理完成后自动删除临时文件
   - 不保存原始图像数据

3. **准确性说明**
   - AI识别结果仅供参考
   - 建议人工核对关键数据
   - 支持手动修正识别错误

## 故障排除

### 常见问题

1. **图像识别失败**
   - 检查图片格式和大小
   - 确认GEMINI_API_KEY配置正确
   - 查看后端日志获取详细错误信息

2. **识别结果不准确**
   - 确保图片清晰度足够
   - 尝试调整图片角度或光线
   - 使用手动编辑功能修正

3. **上传失败**
   - 检查网络连接
   - 确认文件大小未超限制
   - 尝试减少同时上传的文件数量

## 未来改进计划

1. 支持PDF文档识别
2. 批量处理优化
3. 识别准确率提升
4. 更多文档类型支持
5. 离线识别能力