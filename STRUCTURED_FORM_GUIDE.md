# 结构化文本录入功能说明

## 功能概述

为了提高医疗文本录入的准确性和一致性，我们将原有的自由文本输入框替换为结构化表单。新的表单基于标准医疗病历格式，引导医师按照规范的结构填写患者信息。

## 改进背景

**原有问题**：
- 自由文本录入缺乏规范，格式不统一
- 容易遗漏关键信息
- 输入自由度过大，导致AI解析困难
- 数据质量难以保证

**解决方案**：
- 设计结构化表单，将医疗文本拆分为多个标准字段
- 提供下拉选择、数值输入等规范化控件
- 自动计算BMI等派生数据
- 实时验证必填字段

## 表单结构

### 1. 患者基本信息
- 姓名（必填）
- 性别（下拉选择：男/女）
- 年龄（必填，数值）
- 身高（必填，单位：cm）
- 体重（必填，单位：kg）
- BMI（自动计算）

### 2. 病史信息
- **主诉**（必填）：患者入院原因的简短描述
- **现病史**（必填）：详细的病情发展过程
- **既往史**（可选）：过往疾病史、用药史等

### 3. 体格检查
- 体温、血压、脉搏、呼吸（标准生命体征）
- 一般情况：神志、精神状态等
- 腹部检查：腹部触诊、听诊等特殊检查

### 4. 实验室检查

#### 血常规（4项）
- 白细胞计数
- 红细胞计数
- 血红蛋白
- 血小板计数

每项包含：
- 数值输入
- 单位（预设，不可编辑）
- 结果判读（下拉选择：正常/↑偏高/↓偏低）

#### 生化检查（8项）
- 血清白蛋白
- 总蛋白
- 血糖
- 总胆固醇
- 甘油三酯
- 钠、钾、氯（电解质）

每项包含：
- 数值输入
- 单位（预设，不可编辑）
- 结果判读（下拉选择：正常/↑偏高/↓偏低）

### 5. 营养评估
- NRS2002评分（0-7分，数值输入）
- 系统提示：≥3分提示有营养风险

### 6. 初步诊断
- 动态列表，可添加多个诊断
- 每个诊断一行，支持"+ 添加诊断"按钮

### 7. 治疗计划
- 多行文本输入
- 支持编号列表格式

## 技术实现

### 文件结构

```
src/
├── components/
│   └── StructuredTextForm.tsx  # 新增：结构化表单组件
├── app/
│   └── page.tsx                # 修改：集成结构化表单
```

### 核心组件：StructuredTextForm

**位置**：`src/components/StructuredTextForm.tsx`

**Props接口**：
```typescript
interface StructuredTextFormProps {
  onSubmit: (formattedText: string) => void;  // 提交回调
  isProcessing: boolean;                       // 处理状态
}
```

**主要功能**：
1. **表单数据管理**：使用React state管理所有字段
2. **数据格式化**：将结构化数据转换为标准文本格式
3. **自动计算**：BMI自动根据身高体重计算
4. **验证**：必填字段验证
5. **动态列表**：诊断项可动态添加

### 数据流程

```
用户填写表单
    ↓
点击"提交并生成评估"
    ↓
StructuredTextForm.formatToText()
    ↓
生成格式化的医疗文本
    ↓
调用 onSubmit(formattedText)
    ↓
page.tsx: handleTextProcessing(formattedText)
    ↓
发送到 /api/process-text
    ↓
Python backend: text_processing_service.py
    ↓
AI模型提取结构化数据
    ↓
返回JSON格式的患者数据
    ↓
显示在JSON编辑器中
    ↓
用户可进一步编辑后提交评估
```

### 格式化文本示例

表单会将结构化输入转换为以下格式：

```
患者基本信息：
姓名：张三
性别：男
年龄：65岁
身高：170cm
体重：55kg
BMI：19.0

主诉：
患者因"反复腹泻、消瘦3个月"入院。

现病史：
患者3个月前无明显诱因出现腹泻...

既往史：
高血压病史10年，规律服用降压药物。

体格检查：
体温：36.8℃
血压：135/85mmHg
脉搏：88次/分
呼吸：18次/分
神志清楚，精神差，营养不良外观

实验室检查：

血常规：
白细胞计数：5.2×10^9/L
红细胞计数：3.5×10^12/L ↓
血红蛋白：95g/L ↓
...

生化检查：
血清白蛋白：28g/L ↓
总蛋白：55g/L ↓
...

营养评估：
NRS2002评分：5分

初步诊断：
1. 慢性腹泻
2. 中重度营养不良
...

治疗计划：
1. 完善肠镜、腹部CT等检查明确腹泻病因
2. 营养支持治疗...
```

## 使用指南

### 医师操作流程

1. **选择输入模式**
   - 点击"文本录入"标签页

2. **填写结构化表单**
   - 依次填写各部分信息
   - 必填字段用红色星号(*)标记
   - 检查项目可直接选择"正常/↑/↓"

3. **提交表单**
   - 点击"提交并生成评估"按钮
   - 系统自动将表单数据转换为文本

4. **AI处理**
   - 后端AI自动解析文本
   - 提取结构化JSON数据

5. **检查和修改**
   - 在JSON编辑器中检查提取结果
   - 可手动修改不准确的地方

6. **生成评估报告**
   - 选择AI模型系列（Gemini/DeepSeek）
   - 点击"生成营养评估报告"

## 优势

### 1. 数据质量提升
- ✅ 格式统一，结构清晰
- ✅ 必填字段确保关键信息完整
- ✅ 单位预设，避免单位错误
- ✅ 结果判读规范化

### 2. 录入效率提高
- ✅ 字段提示明确，减少思考时间
- ✅ 下拉选择快于手动输入
- ✅ 自动计算BMI
- ✅ 实验室检查项目预设

### 3. AI解析准确性
- ✅ 标准格式更易解析
- ✅ 减少歧义和错误识别
- ✅ 提高数据提取成功率

### 4. 用户体验改善
- ✅ 分段式界面，信息组织清晰
- ✅ 实时验证，及时提示错误
- ✅ 响应式设计，适配不同屏幕
- ✅ 减轻认知负担

## 后续优化方向

1. **数据持久化**
   - 添加本地存储，防止数据丢失
   - 支持草稿保存和恢复

2. **模板功能**
   - 常用诊断快速选择
   - 治疗方案模板库

3. **智能辅助**
   - 根据BMI自动评估营养状态
   - 根据实验室检查自动高亮异常项

4. **批量导入**
   - 支持从HIS系统导入数据
   - 支持Excel批量导入

5. **移动端优化**
   - 触摸友好的交互设计
   - 语音输入支持

## 兼容性

- ✅ 保持与原有JSON输入模式兼容
- ✅ 保持与图像识别模式兼容
- ✅ 支持所有浏览器（Chrome, Firefox, Safari, Edge）
- ✅ 响应式设计，支持移动设备

## 技术栈

- React 18 + TypeScript
- Tailwind CSS（样式）
- Next.js 14（框架）
- 无额外依赖

---

**版本**: 1.0
**更新日期**: 2025-09-30
**开发者**: Claude Code
